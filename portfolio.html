<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Raad K">
    <meta name="description"
          content="Find a portfolio of assets on the efficient frontier that maximizes the sharpe ratio.">
    <link rel="shortcut icon" href="favicon.ico"/>
    <title>Portfolio optimization - raadk.com</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <link rel="stylesheet" href="css/property_styles.css">

    <script
            src="https://code.jquery.com/jquery-3.6.0.min.js"
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>
</head>
<body>
<div class="container">
    <div class="jumbotron">
        <p class="float-right"><a class='btn btn-outline-primary' href="index.html">raadk.com</a></p>
        <h1>Portfolio optimization</h1>
        <p class="text-small text-danger">
            <small>
                Use this at your own risk.
                The information contained within this site is for informational purposes only
                and does not constitute financial or investment advice.
                <br>This site uses pypfopt, empyrical, and yfinance to find a portfolio of assets that maximizes the
                sharpe ratio.
            </small>

        </p>
    </div>


    <div class="row">
        <div class="col-xs-12 col-md-4">
            <div class="card">
                <div class="card-body">
                    <div class="card-title">
                        <a class="no-styling-link" data-toggle="collapse" href="#parameters" role="button"
                           aria-expanded="false" aria-controls="parameters">
                            <h2>Parameters</h2>
                        </a>
                    </div>
                    <div class="" id="parameters">
                        <form id="paramForm">
                            <div class="form-group ticker-wrap">
                                <label for="ticker">Tickers</label>
                                <p class="text-muted">Benchmark</p>
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control ticker-input" id="ticker" name="tickers[]"
                                           value="SPY">
                                    <!--                                    <a href="#" class="btn text-danger remove-ticker">&times;</a>-->
                                </div>
                                <br>
                                <p class="text-muted">Portfolio</p>
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control ticker-input" name="tickers[]" value="GOOG">
                                    <a class="btn text-danger remove-ticker">&times;</a>
                                </div>
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control ticker-input" name="tickers[]" value="AAPL">
                                    <a class="btn text-danger remove-ticker">&times;</a>
                                </div>
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control ticker-input" name="tickers[]" value="INTC">
                                    <a class="btn text-danger remove-ticker">&times;</a>
                                </div>
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control ticker-input" name="tickers[]" value="PFE">
                                    <a class="btn text-danger remove-ticker">&times;</a>
                                </div>
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control ticker-input" name="tickers[]" value="NLY">
                                    <a class="btn text-danger remove-ticker">&times;</a>
                                </div>
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control ticker-input" name="tickers[]" value="SCI">
                                    <a class="btn text-danger remove-ticker">&times;</a>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-secondary" id="add-ticker">+ Add</button>
                            <br><br>


                            <div class="form-group">
                                <label for="portfolioValue">Initial portfolio value</label>
                                <div class="input-group mb-2">
                                    <div class="input-group-prepend">
                                        <div class="input-group-text">$</div>
                                    </div>
                                    <input type="number" class="form-control" id="portfolioValue" value="10000">
                                </div>
                            </div>

                            <!--                            <div class="form-group">-->
                            <!--                                <label for="horizon">Optimization horizon</label>-->
                            <!--                                <div class="input-group mb-2">-->
                            <!--                                    <input type="number" class="form-control" id="horizon" value="5">-->
                            <!--                                </div>-->
                            <!--                            </div>-->

                            <div class="form-group">
                                <label for="minPosition">Min position weight</label>
                                <div class="input-group mb-2">
                                    <input type="number" step="0.01" class="form-control" id="minPosition" value="0">
                                </div>
                                <small id="minPositionHelp" class="form-text text-muted">Negative allows for shorting</small>
                            </div>

                            <div class="form-group">
                                <label for="maxPosition">Max position weight</label>
                                <div class="input-group mb-2">
                                    <input type="number" step="0.01" class="form-control" id="maxPosition" value="1.0">
                                </div>
                            </div>

                            <!--                            <div class="form-group">-->
                            <!--                                <label for="riskHorizon">Risk horizon</label>-->
                            <!--                                <div class="input-group mb-2">-->
                            <!--                                    <input type="number" class="form-control" id="riskHorizon" value="1">-->
                            <!--                                </div>-->
                            <!--                            </div>-->

                            <!--                            <div class="form-group">-->
                            <!--                                <label for="maxBeta">Max beta</label>-->
                            <!--                                <div class="input-group mb-2">-->
                            <!--                                    <input type="number" step="0.01" class="form-control" id="maxBeta" value="1">-->
                            <!--                                </div>-->
                            <!--                            </div>-->

                            <div class="form-group">
                                <label for="startDate">Start date</label>
                                <div class="input-group mb-2">
                                    <input type="date" class="form-control" id="startDate" value="2015-01-01">
                                </div>
                            </div>

                            <button type="submit" class="btn btn-block btn-primary">Optimize portfolio</button>


                        </form>

                    </div>
                </div>
                <!--card-body-->
            </div>
            <!--card-->
        </div>
        <!--col-->

        <div class="col-xs-12 col-md-8">

            <div class="card">
                <div class="card-body">
                    <div class="card-title">
                        <h2>Portfolio Weighting</h2>
                    </div>
                    <div>
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm" id="allocationTable">
                                <thead>
                                </thead>
                                <tbody>
                                <tr>
                                    <td colspan="3">Click <strong>Optimize Portfolio</strong> in the parameters panel to
                                        run analysis
                                    </td>
                                </tr>
                                </tbody>

                            </table>
                        </div>
                    </div>
                </div>
                <!--card-body-->
            </div>
            <!--card-->

            <div class="card">
                <div class="card-body">
                    <div class="card-title">
                        <h2>Summary</h2>
                        <br>
                        <table class="table table-bordered table-sm" id="summaryTable">
                            <thead>
                            </thead>
                            <tbody>
                            </tbody>

                        </table>
                    </div>
                </div>
                <!--card-body-->
            </div>
            <!--card-->

            <div class="card">
                <div class="card-body">
                    <div class="card-title">
                        <h2>Portfolio</h2>
                    </div>
                    <div id="plot_portfolio">
                    </div>
                </div>
                <!--card-body-->
            </div>
            <!--card-->

        </div>
        <!--col-->

    </div>
    <!--row-->
</div>
<!--container-->

<script src="https://cdn.plot.ly/plotly-1.2.0.min.js"></script>


<script>

    function roundToTwo(num) {
        https://stackoverflow.com/questions/11832914/how-to-round-to-at-most-2-decimal-places-if-necessary
            return +(Math.round(num + "e+2") + "e-2");
    }


    var min_tickers = 2 + 1;
    var max_tickers = 100; //maximum input boxes allowed
    var wrapper = $(".ticker-wrap"); //Fields wrapper
    var add_button = $("#add-ticker"); //Add button ID
    var n_ticker_inputs = 1; //initial text box count

    add_button.click(function (e) {
        e.preventDefault();
        if (n_ticker_inputs < max_tickers) { //max input box allowed
            n_ticker_inputs++; //text box increment
            wrapper.append(`
                <div class="input-group mb-2">
                    <input type="text" class="form-control ticker-input" name="tickers[]" value="">
                    <a class="btn text-danger remove-ticker" >&times;</a>
                </div>
            `);
        }
    })

    wrapper.on("click", ".remove-ticker", function (e) { //user click on remove text
        e.preventDefault();
        $(this).parent('div').remove();
        n_ticker_inputs--;
    })

    function writeTable(tableId, tableData, skipFirstHeading = true) {
        let obj

        let thead = $(tableId + ' thead')
        obj = tableData[0]
        let tr = "";
        let i = 0
        for (let [key, value] of Object.entries(obj)) {
            if (!skipFirstHeading || i !== 0) {
                tr += "<td>" + key + "</td>"
            } else {
                tr += "<td></td>"
            }
            i++;
        }
        tr += ""
        thead.append(tr);


        let tbody = $(tableId + ' tbody')
        for (let i = 0; i < tableData.length; i++) {
            obj = tableData[i]
            let tr = "<tr>";
            for (let [key, value] of Object.entries(obj)) {
                tr += "<td>" + value + "</td>"
            }
            tbody.append(tr);
        }
    }

    function unpack(rows, key) {
        return rows.map(function (row) {
            return row[key];
        });
    }


    var allocationTableBody = $('#allocationTable tbody')
    var allocationTableHead = $('#allocationTable thead')

    var summaryTableBody = $('#summaryTable tbody')
    var summaryTableHead = $('#summaryTable thead')

    function clearTables() {
        allocationTableBody.empty()
        allocationTableHead.empty()
        summaryTableHead.empty()
        summaryTableBody.empty()
    }

    function runAnalysis() {

        $('#plot_portfolio').empty()

        clearTables()
        allocationTableBody.append(`<tr><td colspan="3">Loading...</td></tr>`)

        let tickers = [];
        $(".ticker-input").each(function (index) {
            let symbol = $(this).val();
            if (symbol !== "") {
                tickers.push(symbol);
            }
        });

        if (tickers.length < min_tickers) {
            alert(`Please provide at least ${min_tickers - 1} or more tickers in addition to the benchmark`)
            return;
        }
        let portfolioValue = parseFloat($('#portfolioValue').val());
        let minPosition = parseFloat($('#minPosition').val());
        let maxPosition = parseFloat($('#maxPosition').val());
        let startDate = $('#startDate').val();

        // let horizon = parseInt($('#horizon').val());
        // let riskHorizon = parseInt($('#riskHorizon').val());
        // let maxBeta = parseFloat($('#maxBeta').val());

        let parameters = {
            tickers: tickers,
            portfolioValue: portfolioValue,
            minPosition: minPosition,
            maxPosition: maxPosition,
            startDate: startDate,
        }

        console.log("parameters")
        console.log(parameters)

        var str_params = $.param(parameters);
        // let apiURL = 'http://127.0.0.1:8000/portfolio?' + str_params
        let apiURL = 'http://46.101.78.204:89/portfolio?' + str_params

        $.get(apiURL, function (data) {

            clearTables()
            if (!data['success']) {
                allocationTableBody.append(`<tr><td colspan="3">Error. ${data['error']}</td></tr>`)
                return;
            }
            let summary = JSON.parse(data['summary']);
            console.log(summary)
            writeTable('#summaryTable', summary);

            let cumReturns = JSON.parse(data['cum_returns'])
            let prices = JSON.parse(data['prices'])

            let allocation = JSON.parse(data['allocation']['allocation'])
            writeTable('#allocationTable', allocation);

            let remaining_funds = JSON.parse(data['allocation']['remaining_funds'])
            allocationTableBody.append(`<tr> <td colspan="5"><em>Remaining funds $${remaining_funds}</em></td></tr>`)

            var data = [
                {
                    x: unpack(cumReturns, "Date"),
                    y: unpack(cumReturns, "Portfolio"),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Portfolio',
                    line: {color: '#33b38d'}
                },
                {
                    x: unpack(cumReturns, "Date"),
                    y: unpack(cumReturns, "Equal Allocation"),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Equal Allocation',
                    line: {color: '#17becf'}
                },
                {
                    x: unpack(cumReturns, "Date"),
                    y: unpack(cumReturns, "Benchmark"),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Benchmark',
                    line: {color: '#888888'}
                }
            ];
            var layout = {
                // title: 'Cumulative returns',
                legend: {"orientation": "h"},
                yaxis: {title: 'Cumulative return'}
            };

            Plotly.newPlot('plot_portfolio', data, layout);
        })


    }


    $("#paramForm").on('submit', function (e) {
        e.preventDefault();
        runAnalysis();
    })

</script>

<script>
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
            m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-98396812-4', 'auto');
    ga('send', 'pageview');
</script>


</body>

</html>
